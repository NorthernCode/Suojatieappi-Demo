<html>
<head>
	<script type="text/javascript" src="lib/jquery-1.11.3.min.js"></script>
	<title>Suojatie - Demo</title>
</head>
<body>
        <div>Turvassa yli!</div>
	<div id="gps"></div>
	<div id="data"></div>
	<div id="sandbox" style="border:solid;"></div>
	<script type="text/javascript">
		var gpsEvents = [];
		var gps;
		function getGPS(){
			if(navigator.geolocation){
				var options = {timeout:60000, enableHighAccuracy:true};
                navigator.geolocation.watchPosition(showPos, errorHandler, options);
			}else{
				alert("no gps");
			}
		}
		function showPos(location){
			gps = location;
			$("#gps").text("Location:" + location.coords.latitude.toFixed(2) + "," +location.coords.longitude.toFixed(2));
			getData();
		}

		function errorHandler(err) {
            if(err.code == 1) {
               alert("Error: Access is denied!");
            }
            
            else if( err.code == 2) {
               alert("Error: Position is unavailable!");
            }
        }

        function showData(data){
         	$( "#data" ).text( data.elements[0].lat );
        }

        function getData(){
        	var gpsString = "" + gps.coords.latitude.toFixed(2) + "," + gps.coords.longitude.toFixed(2) + "," + (gps.coords.latitude + 0.01).toFixed(2) + "," + (gps.coords.longitude + 0.01).toFixed(2)
			$.ajax({
			     url:"http://overpass-api.de/api/interpreter?data=[out:json];node%20[%22highway%22=%22crossing%22]("+ gpsString + ");%20out%3B",
			     dataType: 'json',
			     success:function(json){
			         	showData(json);
			        },
			     error:function(){
			         alert("Error");
			     }      
			});
        }

        function getAcc(event){
        	var acc = event.acceleration;
        	gpsEvents.push(acc);
			$("#acc").text("Acceleration: X: " + (acc.x).toFixed(1) + " Y: " + (acc.y).toFixed(1) + " Z: " + (acc.z).toFixed(1));
        }

        if (window.DeviceMotionEvent) {
		  window.addEventListener('devicemotion', getAcc, false);
		} else {
		  $("#acc").text('HTML5 Acceleration not supported.');
		}

		setInterval(function(){
			var latestEvents = gpsEvents.slice();
			var sum = [];
			sum.x = 0.0;
			sum.y = 0.0;
			sum.z = 0.0;
			$("#rate").text("Rate: " + latestEvents.length);
			for(var i=0; i < latestEvents.length; i++){
				sum.x += latestEvents[i].x;
				sum.y += latestEvents[i].y;
				sum.z += latestEvents[i].z;
			}
			$("#sum").text("SUM X: " + sum.x + " SUM Y: " + sum.y + " SUM Z: " + sum.z);
			gpsEvents = [];
		}, 2000);
		getGPS();
	</script>
	<script type="text/javascript" src="script.js"></script>
</body>
</html>
